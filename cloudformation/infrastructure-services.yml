AWSTemplateFormatVersion: '2010-09-09'
Description: 'SO9631 Services Infrastructure for Bid Simulator - Lambda Functions, DynamoDB'

Parameters:
  StackPrefix:
    Type: String
    Default: 'sim'
    Description: Stack prefix for resource naming
    MinLength: 3
    MaxLength: 10
    AllowedPattern: ^[a-z0-9]+$
    ConstraintDescription: Must be 3-10 lowercase alphanumeric characters.

  UniqueId:
    Type: String
    Default: 'default'
    Description: Additional unique identifier for resource naming
    MinLength: 1
    MaxLength: 15
    AllowedPattern: ^[a-zA-Z0-9]+$
    ConstraintDescription: Must contain only alphanumeric characters.

  ImageGenerationModel:
    Type: String
    Description: Model ID for image generation
    Default: 'stability.sd3-5-large-v1:0'

  AsyncImageProcessorS3Bucket:
    Type: String
    Description: S3 bucket containing the async image processor Lambda code
    Default: ''

  AsyncImageProcessorS3Key:
    Type: String
    Description: S3 key for the async image processor Lambda code
    Default: 'lambda/async-image-processor.zip'

Resources:
  GeneratedContentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${StackPrefix}-generated-content-${UniqueId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ["*"]
            AllowedMethods: ["GET", "PUT", "POST", "DELETE"]
            AllowedOrigins: ["*"]
            ExposedHeaders: []

  # DynamoDB Table for Generated Content
  GeneratedContentTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${StackPrefix}-ImageStatus-${UniqueId}'
      AttributeDefinitions:
        - AttributeName: content_id
          AttributeType: S
      KeySchema:
        - AttributeName: content_id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  # DynamoDB Table for Visualizations
  VisualizationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${StackPrefix}-Visualizations-${UniqueId}'
      AttributeDefinitions:
        - AttributeName: item_type
          AttributeType: S
        - AttributeName: item_id
          AttributeType: S
        - AttributeName: agent_id
          AttributeType: S
        - AttributeName: template_id
          AttributeType: S
      KeySchema:
        - AttributeName: item_type
          KeyType: HASH
        - AttributeName: item_id
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: AgentTypeIndex
          KeySchema:
            - AttributeName: agent_id
              KeyType: HASH
            - AttributeName: template_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: TemplateTypeIndex
          KeySchema:
            - AttributeName: template_id
              KeyType: HASH
            - AttributeName: item_type
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  # IAM Role for Async Image Processor
  AsyncImageProcessorRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${StackPrefix}-async-image-processor-role-${UniqueId}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource: 
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.nova-canvas-v1:0'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/stability.stable-diffusion-xl-v1'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/stability.sd3-large-v1:0'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/stability.sd3-5-large-v1:0'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/stability.*'
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub '${GeneratedContentBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt GeneratedContentBucket.Arn
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource: !GetAtt GeneratedContentTable.Arn

  # Async Image Processor Lambda Function
  AsyncImageProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${StackPrefix}-async-image-processor-${UniqueId}'
      Runtime: python3.11
      Handler: async_image_processor.lambda_handler
      Role: !GetAtt AsyncImageProcessorRole.Arn
      Code:
        S3Bucket: !Ref AsyncImageProcessorS3Bucket
        S3Key: !Ref AsyncImageProcessorS3Key
      Environment:
        Variables:
          GENERATED_CONTENT_BUCKET: !Ref GeneratedContentBucket
          GENERATED_CONTENT_TABLE: !Ref GeneratedContentTable
          IMAGE_GENERATION_MODEL: !Ref ImageGenerationModel
      Timeout: 900  # 15 minutes for image generation
      MemorySize: 1024

  # IAM Role for Creative Image Generator Lambda
  CreativeImageGeneratorLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${StackPrefix}-CreativeImageGeneratorRole-${UniqueId}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: AsyncProcessorInvokeAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt AsyncImageProcessorFunction.Arn
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource: !GetAtt GeneratedContentTable.Arn

  # Creative Image Generator Lambda Function
  CreativeImageGeneratorLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${StackPrefix}-CreativeImageGenerator-${UniqueId}'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt CreativeImageGeneratorLambdaRole.Arn
      Timeout: 900
      MemorySize: 1024
      Environment:
        Variables:
          GENERATED_CONTENT_BUCKET: !Ref GeneratedContentBucket
          GENERATED_CONTENT_TABLE: !Ref GeneratedContentTable
          ASYNC_IMAGE_PROCESSOR_FUNCTION: !Ref AsyncImageProcessorFunction
      Code:
        ZipFile: |
          import json
          import boto3
          import uuid
          import os
          from datetime import datetime
          import logging

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          class ImageGeneratorService:
              def __init__(self):
                  self.lambda_client = boto3.client('lambda')
                  self.bucket_name = os.environ.get('GENERATED_CONTENT_BUCKET')
                  self.table_name = os.environ['GENERATED_CONTENT_TABLE']
                  self.async_processor_function = os.environ.get('ASYNC_IMAGE_PROCESSOR_FUNCTION', 'async-image-processor')
                  self.table = boto3.resource('dynamodb').Table(self.table_name)
              
              def invoke_async_processor(self, image_jobs):
                  """Invoke the async image processor Lambda function"""
                  try:
                      payload = {
                          'image_jobs': image_jobs
                      }
                      
                      # Invoke the async processor function
                      response = self.lambda_client.invoke(
                          FunctionName=self.async_processor_function,
                          InvocationType='Event',  # Asynchronous invocation
                          Payload=json.dumps(payload)
                      )
                      
                      logger.info(f"Successfully invoked async processor for {len(image_jobs)} jobs")
                      return True
                      
                  except Exception as e:
                      logger.error(f"Error invoking async processor: {str(e)}")
                      raise

              def create_pending_record(self, content_id, prompt, full_image_key, thumbnail_key):
                  """Create a pending record in DynamoDB"""
                  try:
                      item = {
                          'content_id': content_id,
                          'content_type': 'image',
                          'status': 'pending',
                          'original_url': '',
                          'thumbnail_url': '',
                          'prompt': prompt,
                          'key': full_image_key,
                          'bucket': self.bucket_name,
                          'created_date': datetime.now().isoformat()
                      }
                      
                      self.table.put_item(Item=item)
                      logger.info(f"Created pending record for content_id: {content_id}")
                      return item
                      
                  except Exception as e:
                      logger.error(f"Error creating pending record: {str(e)}")
                      raise

          def lambda_handler(event, context):
              """Main Lambda handler for image generation actions"""
              try:
                  logger.info(f"Received event: {json.dumps(event)}")
                  
                  # Parse the action and parameters
                  action = event.get('actionGroup', '')
                  function_name = event.get('function', '')
                  parameters = event.get('parameters', [])
                  message_version = event.get('messageVersion',1)
                  
                  # Initialize the service
                  service = ImageGeneratorService()
                  
                  return handle_generate_creative_image(action, function_name, message_version, service, parameters)
                      
              except Exception as e:
                  logger.error(f"Error in lambda_handler: {str(e)}")
                  return {
                      'statusCode': 500,
                      'body': {
                          'application/json': {
                              'body': json.dumps({
                                  'error': f'Internal server error: {str(e)}'
                              })
                          }
                      }
                  }

          def parse_parameters(parameters):
              """Parse parameters array into a dictionary"""
              param_dict = {}
              for param in parameters:
                  name = param.get('name')
                  value = param.get('value')
                  param_type = param.get('type')
                  
                  if name and value is not None:
                      # Handle different parameter types
                      if param_type == 'string':
                          # Check if it's a comma-separated list that should be an array
                          if name in ['colorScheme', 'descriptions'] and ',' in str(value):
                              param_dict[name] = [item.strip() for item in str(value).split(',')]
                          else:
                              param_dict[name] = str(value)
                      elif param_type == 'array':
                          # Handle array types
                          if isinstance(value, list):
                              param_dict[name] = value
                          else:
                              # Try to parse as JSON array or comma-separated
                              try:
                                  param_dict[name] = json.loads(value) if isinstance(value, str) else [str(value)]
                              except:
                                  param_dict[name] = [item.strip() for item in str(value).split(',')]
                      else:
                          param_dict[name] = value
              
              return param_dict

          def handle_generate_creative_image(action, function, message_version, service, parameters):
              """Handle image generation request - returns content IDs immediately"""
              try:
                  # Parse the parameters array into a dictionary
                  parsed_params = parse_parameters(parameters)
                  
                  # Extract color scheme (handle both single string and array formats)
                  color_scheme = parsed_params.get('colorScheme', [])
                  if isinstance(color_scheme, str):
                      color_scheme = [item.strip() for item in color_scheme.split(',')]
                  color_scheme_text = ", ".join(color_scheme) if color_scheme else ""
                  
                  # Extract descriptions (handle both single description and descriptions array)
                  prompts = parsed_params.get('descriptions', [])
                  if not prompts:
                      # Fallback to single description parameter
                      single_desc = parsed_params.get('description', '')
                      if single_desc:
                          prompts = [single_desc]
                  
                  if not prompts:
                      return {
                          'statusCode': 400,
                          'body': {
                              'application/json': {
                                  'body': json.dumps({
                                      'error': 'Descriptions are required'
                                  })
                              }
                          }
                      }
                  
                  width = int(parsed_params.get('width', 1024))
                  height = int(parsed_params.get('height', 1024))
                  
                  # Prepare batch of image jobs for async processing
                  image_jobs = []
                  pending_records = []
                  
                  for prompt in prompts:
                      # Add color scheme to prompt if available
                      if color_scheme_text:
                          enhanced_prompt = f"{prompt}, color scheme: {color_scheme_text}"
                      else:
                          enhanced_prompt = prompt
                      
                      # Generate unique identifiers
                      image_id = str(uuid.uuid4())
                      timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                      
                      # Generate S3 keys
                      full_image_key = f"imagery/{timestamp}_{image_id}_full.jpg"
                      thumbnail_key = f"imagery/{timestamp}_{image_id}_thumb.jpg"
                      
                      # Create pending record in DynamoDB
                      pending_item = service.create_pending_record(
                          content_id=image_id,
                          prompt=enhanced_prompt,
                          full_image_key=full_image_key,
                          thumbnail_key=thumbnail_key
                      )
                      
                      # Create job for async processor
                      image_job = {
                          'content_id': image_id,
                          'prompt': enhanced_prompt,
                          'width': width,
                          'height': height,
                          'full_image_key': full_image_key,
                          'thumbnail_key': thumbnail_key
                      }
                      
                      image_jobs.append(image_job)
                      pending_records.append(pending_item)
                  
                  # Invoke async processor for all jobs
                  service.invoke_async_processor(image_jobs)
                  
                  logger.info(f"Created {len(pending_records)} pending image records and queued for async processing")

                  # refer to: https://docs.aws.amazon.com/bedrock/latest/userguide/agents-lambda.html
                  response_body = {
                      'TEXT': {
                          'body': json.dumps(pending_records)
                      }
                  }
                  action_response = {
                      'actionGroup': action,
                      'function': function,
                      'functionResponse': {
                          'responseBody': response_body
                      }
                  }
                  response = {
                      'response': action_response,
                      'messageVersion': message_version
                  }

                  logger.info('Response: %s', response)
                  return response

              except KeyError as e:
                  logger.error('Missing required field: %s', str(e))
                  return {
                      'statusCode': 400,
                      'body': f'Error: {str(e)}'
                  }
              except Exception as e:
                  logger.error('Unexpected error: %s', str(e))
                  return {
                      'statusCode': 500,
                      'body': 'Internal server error'
                  }


  # Permission for Creative Image Generator to invoke Async Processor
  AsyncProcessorInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AsyncImageProcessorFunction
      Action: lambda:InvokeFunction
      Principal: lambda.amazonaws.com
      SourceArn: !GetAtt CreativeImageGeneratorLambda.Arn

Outputs:
  VisualizationsTableName:
    Description: 'Name of the Visualizations DynamoDB table'
    Value: !Ref VisualizationsTable
    Export:
      Name: !Sub '${StackPrefix}-VisualizationsTableName-${UniqueId}'

  VisualizationsTableArn:
    Description: 'ARN of the Visualizations DynamoDB table'
    Value: !GetAtt VisualizationsTable.Arn
    Export:
      Name: !Sub '${StackPrefix}-VisualizationsTableArn-${UniqueId}'

  CreativeImageGeneratorLambdaArn:
    Description: 'ARN of the Creative Image Generator Lambda function'
    Value: !GetAtt CreativeImageGeneratorLambda.Arn
    Export:
      Name: !Sub '${StackPrefix}-CreativeImageGeneratorLambdaArn-${UniqueId}'

  CreativeImageGeneratorLambdaName:
    Description: 'Name of the Creative Image Generator Lambda function'
    Value: !Ref CreativeImageGeneratorLambda
    Export:
      Name: !Sub '${StackPrefix}-CreativeImageGeneratorLambdaName-${UniqueId}'

  AsyncImageProcessorFunctionArn:
    Description: ARN of the Async Image Processor Lambda function
    Value: !GetAtt AsyncImageProcessorFunction.Arn
    Export:
      Name: !Sub '${StackPrefix}-AsyncImageProcessorFunctionArn-${UniqueId}'
  
  AsyncImageProcessorFunctionName:
    Description: Name of the Async Image Processor Lambda function
    Value: !Ref AsyncImageProcessorFunction
    Export:
      Name: !Sub '${StackPrefix}-AsyncImageProcessorFunctionName-${UniqueId}'
   
  GeneratedContentBucketName:
    Description: Name of the generated content S3 bucket
    Value: !Ref GeneratedContentBucket
    Export:
      Name: !Sub '${StackPrefix}-GeneratedContentBucketName-${UniqueId}'
    
  GeneratedContentTableName:
    Description: Name of the generated content DynamoDB table
    Value: !Ref GeneratedContentTable
    Export:
      Name: !Sub '${StackPrefix}-GeneratedContentTableName-${UniqueId}'
   
  GeneratedContentTableArn:
    Description: ARN of the generated content DynamoDB table
    Value: !GetAtt GeneratedContentTable.Arn
    Export:
      Name: !Sub '${StackPrefix}-GeneratedContentTableArn-${UniqueId}'